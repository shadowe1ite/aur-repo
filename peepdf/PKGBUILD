pkgname=peepdf
pkgver=0.5.9
pkgrel=1
pkgdesc="PDF analysis tool"
arch=('x86_64')
url="https://github.com/cert-ee/peepdf"
license=('GPL')
depends=('python' 'python-colorama' 'python-six' 'python-pillow' 'python-editorconfig')
makedepends=('python-pip' 'git' 'base-devel' 'cmake' 'autoconf' 'libtool' 'automake')

source=(
    "git+https://github.com/cert-ee/peepdf"
    "PyV8-0.9.linux-x86_64.tar.gz::https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/pyv8/PyV8-0.9.linux-x86_64.tar.gz"
    "libemu::git+https://github.com/buffer/libemu"
)
sha256sums=('SKIP' 'SKIP' 'SKIP')

build() {
    cd "$srcdir/peepdf"
    # Build peepdf wheel
    python -m pip wheel . -w "$srcdir/wheel" --no-deps --use-pep517
}

package() {
    # Install peepdf wheel
    cd "$srcdir/wheel"
    for whl in *.whl; do
        python -m pip install --root="$pkgdir" --no-deps --prefix=/usr "$whl"
    done

    # Install missing Python deps
    pip install --root="$pkgdir" --no-deps jsbeautifier future pythonaes

    # Install PyV8 prebuilt
    mkdir -p "$pkgdir/usr/lib/python3.13/site-packages/"
    bsdtar -xf "$srcdir/PyV8-0.9.linux-x86_64.tar.gz" -C "$pkgdir/usr/lib/python3.13/site-packages/"
    ln -s "PyV8" "$pkgdir/usr/lib/python3.13/site-packages/v8"

    # Build & install libemu
    cd "$srcdir/libemu"
    autoreconf -v -i
    ./configure --prefix=/usr
    make
    make DESTDIR="$pkgdir" install

    # Build pylibemu with correct include/library paths
    cd "$srcdir"
    export CFLAGS="-I$pkgdir/usr/include"
    export LDFLAGS="-L$pkgdir/usr/lib"
    pip wheel pylibemu --no-deps -w "$srcdir/wheel_pylibemu"
    cd "$srcdir/wheel_pylibemu"
    for whl in *.whl; do
        python -m pip install --root="$pkgdir" --no-deps --prefix=/usr "$whl"
    done
}
